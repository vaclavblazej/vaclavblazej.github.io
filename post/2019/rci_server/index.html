<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>
        
            Jak rozběhnout výpočet na RCI serveru - Homepage of Vašek
        
    </title>
    <meta name="description" content="Homepage of Vašek">
    <meta name="author" content="">

    
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <link href="https://vaclavblazej.github.io//font/fonts.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://vaclavblazej.github.io/css/fonts.css">

    
    <script src="https://vaclavblazej.github.io/js/custom.js"></script>
    <link rel="stylesheet" href="https://vaclavblazej.github.io/css/custom.css">

    <link rel="shortcut icon" href="https://vaclavblazej.github.io//favicon.ico" />

    

    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [ ['$','$'] ],
                displayMath: [ ["\\[","\\]"] ],
                processEscapes: true,
                autoload: {
                    color: [],
                    colorv2: ['color']
                },
                packages: {'[+]': ['noerrors']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process',
                renderActions: {
                    addMenu: [0, '', '']
                }
            },
            loader: {
                load: ['[tex]/noerrors']
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script"></script>

    <script src="https://vaclavblazej.github.io/js/jquery.min.js" type="text/javascript"></script>

</head>
<body>

<div class="header noprint">
    
    <div class="desktop nav-menu">
        <a href="https://vaclavblazej.github.io/" class="site-title pad">Homepage of Vašek</a>
        <ul>
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/">Material</a>
            </li>
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/post/">Blog</a>
            </li>
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/teaching/">Teaching</a>
            </li>
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/pub/">Research</a>
            </li>
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/about/">About</a>
            </li>
            
        </ul>
    </div>
    <div class="mobile nav-menu">
        <a href="https://vaclavblazej.github.io/" class="site-title pad">Homepage of Vašek</a>
        <a href="#" id="toggle-btn">&#9776;</a>
    </div>
    <div>
        <ul id="toggle-content" style="display:none;">
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/">Material</a>
            </li>
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/post/">Blog</a>
            </li>
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/teaching/">Teaching</a>
            </li>
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/pub/">Research</a>
            </li>
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/about/">About</a>
            </li>
            
        </ul>
    </div>
</div>



<div class="content">
    
    <div class="post">
        <div class="post-title">
            <p class="footnote">
                


    <time datetime="2019-07-15T00:00:00Z" class="post-list timeago">15.07.2019</time>






    |



    tags:[ <a href="https://vaclavblazej.github.io/tags/research">research</a> <a href="https://vaclavblazej.github.io/tags/setup">setup</a> ]






            </p>
            <h1>Jak rozběhnout výpočet na RCI serveru</h1>

            

        </div>
        <div class="post-content">
            <h2 id="základní-info">Základní info</h2>
<p><a href="https://login.rci.cvut.cz/wiki/how_to_start"target="_blank">Oficiální návod<span style="white-space: nowrap;">&thinsp;↗</span></a> je dobrý.
Obsahuje všechno a je dobře udržovaný.
Na následující stránce shrnu jak jsem server použil, a také pár drobností, které mě překvapily, nebo jsem je v návodu nenašel.</p>
<p>Přístup na server je rozdělen: přihlášení dovede uživatele na login1 node.
Ten není výpočetní, a chybí mu například kompilátor.
Na výpočetní node se dá dostat pomocí <code>srun --pty bash -i</code>, a kompilovat přes <code>srun make</code>.</p>
<h2 id="odkazy">Odkazy:</h2>
<ul>
<li><a href="https://login.rci.cvut.cz/wiki/news"target="_blank">novinky<span style="white-space: nowrap;">&thinsp;↗</span></a></li>
<li><a href="https://login.rci.cvut.cz/wiki/start"target="_blank">stránka s různorodým INFO<span style="white-space: nowrap;">&thinsp;↗</span></a></li>
<li><a href="https://login.rci.cvut.cz/ganglia/"target="_blank">zatížení RCI clusteru<span style="white-space: nowrap;">&thinsp;↗</span></a></li>
<li><a href="https://login.rci.cvut.cz/xdmod/"target="_blank">statistiky zatížení dle jobů a skupin<span style="white-space: nowrap;">&thinsp;↗</span></a></li>
<li><a href="https://login.rci.cvut.cz/ganglia/?r=2hr&amp;cs=&amp;ce=&amp;m=load_one&amp;tab=v&amp;vn=GPU&#43;load"target="_blank">zatížení GPU nodů<span style="white-space: nowrap;">&thinsp;↗</span></a></li>
<li><a href="https://join.slack.com/t/ctu-rci/shared_invite/enQtNTgyNTIzNDI1NTA5LTdmZTNmOGVhMDM4MGQ4YWFjYzYxZWI3YWQzNDRiY2E1ODk1NmU4ZDExYmM0NTQ0YzljMzhhMWRmYTM4ZTU1YjU"target="_blank">chat s dalšímy uživately (Slack)<span style="white-space: nowrap;">&thinsp;↗</span></a></li>
</ul>
<hr>
<h2 id="přihlášení">Přihlášení</h2>
<ul>
<li>nastavit si heslo pro cluster na <a href="https://login.rci.cvut.cz/secure/password/"target="_blank">https://login.rci.cvut.cz/secure/password/<span style="white-space: nowrap;">&thinsp;↗</span></a>.</li>
<li>příhlásit se přes <code>ssh username@login.rci.cvut.cz</code></li>
</ul>
<p>Přihlášení dostane uživatele na <strong>login1</strong> node, který není výpočetní.</p>
<h2 id="zadání-jobu-na-výpočetní-node">Zadání jobu na výpočetní node</h2>
<p>Na serveru lze naplánovat spuštění konkrétního scriptu s danými parametry.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sbatch -p cpu -t <span style="color:#0550ae">1440</span> ./batch.sh par1 par2 ...
</span></span></code></pre></div><p>Script může spustit executable a uložit výsledek.</p>
<p><strong>batch.sh</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#57606a">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#953800">ID</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;</span><span style="color:#953800">$1</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#953800">FILE</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;res/</span><span style="color:#953800">$ID</span><span style="color:#0a3069">.txt&#34;</span>
</span></span><span style="display:flex;"><span>./barrington/src/quick.exe <span style="color:#0a3069">&#34;</span><span style="color:#953800">$ID</span><span style="color:#0a3069">&#34;</span> &gt; <span style="color:#0a3069">&#34;</span><span style="color:#953800">$FILE</span><span style="color:#0a3069">&#34;</span>
</span></span></code></pre></div><h2 id="mail-notifikace-při-dopočítání">Mail notifikace při dopočítání</h2>
<p>Výpočetní nody nemají přístup k odesílání mailu.
Lze to obejít tak, že zapíše záznam do souboru, který hlídá proces na login1 nodu.</p>
<p>Upravíme script spuštění, aby po skončení zadal spustil script na uložení záznamu o mailu.</p>
<p><strong>batch.sh</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#57606a">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#953800">ID</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;</span><span style="color:#953800">$1</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#953800">FILE</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;res/</span><span style="color:#953800">$ID</span><span style="color:#0a3069">.txt&#34;</span>
</span></span><span style="display:flex;"><span>./barrington/src/quick.exe <span style="color:#0a3069">&#34;</span><span style="color:#953800">$ID</span><span style="color:#0a3069">&#34;</span> &gt; <span style="color:#0a3069">&#34;</span><span style="color:#953800">$FILE</span><span style="color:#0a3069">&#34;</span> <span style="color:#0a3069">\
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#0550ae">&amp;&amp;</span> ./notify_mail.sh <span style="color:#0a3069">&#34;</span><span style="color:#953800">$FILE</span><span style="color:#0a3069">&#34;</span>
</span></span></code></pre></div><p>Script záznam uloží do souboru.</p>
<p><strong>notify_mail.sh</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#57606a">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#953800">FILE</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;</span><span style="color:#953800">$1</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#953800">NOTIFICATION_FILE</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;list_mails_to_send.txt&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">echo</span> <span style="color:#0a3069">&#34;</span><span style="color:#953800">$FILE</span><span style="color:#0a3069">&#34;</span> &gt;&gt; <span style="color:#0a3069">&#34;</span><span style="color:#953800">$NOTIFICATION_FILE</span><span style="color:#0a3069">&#34;</span>
</span></span></code></pre></div><p>Pomocí <code>tmux</code> spustíme script, co kontroluje soubor.
Konkrétně sekvencí <code>tmux</code>, <code>./watch_mail.sh</code>, a zkratkou <code>Ctrl+B, D</code>, se zapne nový bash se scriptem, který poběží na pozadí.
Když se v souboru oběví záznam, předá úkol mailovacímu scriptu.
Vrátit k session na pozadí se vrátíme přes <code>tmux attach</code>.</p>
<p><strong>watch_mail.sh</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#57606a">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span>
</span></span><span style="display:flex;"><span><span style="color:#953800">NOTIFICATION_FILE</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;list_mails_to_send.txt&#39;</span>
</span></span><span style="display:flex;"><span>touch <span style="color:#0a3069">&#34;</span><span style="color:#953800">$NOTIFICATION_FILE</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">while</span> <span style="color:#0550ae">[</span> <span style="color:#0550ae">1</span> <span style="color:#0550ae">]</span><span style="color:#1f2328">;</span> <span style="color:#cf222e">do</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">while</span> <span style="color:#6639ba">read</span> LINE<span style="color:#1f2328">;</span> <span style="color:#cf222e">do</span>
</span></span><span style="display:flex;"><span>        <span style="color:#6639ba">echo</span> <span style="color:#0a3069">&#34;detected mail </span><span style="color:#953800">$LINE</span><span style="color:#0a3069">, sending&#34;</span>
</span></span><span style="display:flex;"><span>        ./mail.sh <span style="color:#0a3069">&#34;</span><span style="color:#953800">$LINE</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">done</span> &lt; <span style="color:#0a3069">&#34;</span><span style="color:#953800">$NOTIFICATION_FILE</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">echo</span> -n <span style="color:#0a3069">&#34;&#34;</span> &gt; <span style="color:#0a3069">&#34;</span><span style="color:#953800">$NOTIFICATION_FILE</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>    sleep <span style="color:#0550ae">60</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">done</span>
</span></span></code></pre></div><p>Mail se pošle pomocí utility <code>mail</code>.
Zde je nastaveno aby v předmětu mailu byla poslední řádka souboru, a celý soubor je předán jako obsah mailu.</p>
<p><strong>mail.sh</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#57606a">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#953800">FILE</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;</span><span style="color:#953800">$1</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#953800">MAIL</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;username@fit.cvut.cz&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#953800">SUBJECT</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;</span><span style="color:#cf222e">$(</span>tail -1 <span style="color:#0a3069">&#34;</span><span style="color:#953800">$FILE</span><span style="color:#0a3069">&#34;</span><span style="color:#cf222e">)</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>cat <span style="color:#0a3069">&#34;</span><span style="color:#953800">$FILE</span><span style="color:#0a3069">&#34;</span> <span style="color:#1f2328">|</span> mail -s <span style="color:#0a3069">&#34;Results from RCI server: </span><span style="color:#953800">$SUBJECT</span><span style="color:#0a3069">&#34;</span> <span style="color:#0a3069">&#34;</span><span style="color:#953800">$MAIL</span><span style="color:#0a3069">&#34;</span> <span style="color:#0a3069">\
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span><span style="color:#0550ae">&amp;&amp;</span> <span style="color:#6639ba">echo</span> <span style="color:#0a3069">&#34;sent mail to &#39;</span><span style="color:#953800">$MAIL</span><span style="color:#0a3069">&#39; : </span><span style="color:#953800">$SUBJECT</span><span style="color:#0a3069">&#34;</span>
</span></span></code></pre></div>
        </div>
    </div>
</div>

<div class="footer">
    <ul class="pad-content">

        <li>
            © Václav Blažej
            
                2019
            
        </li>
        

        

        
    </ul>
    <ul title="Last update of the website" class="pull-right pad">26. January 2025</ul>
</div>

<script type="text/javascript">
    $("#toggle-btn").click(function(){
        $("#toggle-content").toggle();
        if($(this).html() === "☰") {
            $(this).html("X")
        } else {
            $(this).html("☰")
        }
    });
    $(window).resize(function(){
        if(window.innerWidth > 768) {
            $(".desktop").removeAttr("style");
        }
    });
</script>
</body>
</html>

