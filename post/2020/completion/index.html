<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>
        
            Command-line completion - Homepage of Vašek
        
    </title>
    <meta name="description" content="Homepage of Vašek">
    <meta name="author" content="">

    
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <link href="https://vaclavblazej.github.io//font/fonts.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://vaclavblazej.github.io/css/fonts.css">

    
    <script src="https://vaclavblazej.github.io/js/custom.js"></script>
    <link rel="stylesheet" href="https://vaclavblazej.github.io/css/custom.css">

    <link rel="shortcut icon" href="https://vaclavblazej.github.io//favicon.ico" />

    

    
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [ ['$','$'] ],
                displayMath: [ ["\\[","\\]"] ],
                processEscapes: true,
                autoload: {
                    color: [],
                    colorv2: ['color']
                },
                packages: {'[+]': ['noerrors']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process',
                renderActions: {
                    addMenu: [0, '', '']
                }
            },
            loader: {
                load: ['[tex]/noerrors']
            }
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" id="MathJax-script"></script>

    <script src="https://vaclavblazej.github.io/js/jquery.min.js" type="text/javascript"></script>

</head>
<body>

<div class="header noprint">
    
    <div class="desktop nav-menu">
        <a href="https://vaclavblazej.github.io/" class="site-title pad">Homepage of Vašek</a>
        <ul>
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/">Material</a>
            </li>
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/post/">Blog</a>
            </li>
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/teaching/">Teaching</a>
            </li>
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/pub/">Research</a>
            </li>
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/about/">About</a>
            </li>
            
        </ul>
    </div>
    <div class="mobile nav-menu">
        <a href="https://vaclavblazej.github.io/" class="site-title pad">Homepage of Vašek</a>
        <a href="#" id="toggle-btn">&#9776;</a>
    </div>
    <div>
        <ul id="toggle-content" style="display:none;">
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/">Material</a>
            </li>
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/post/">Blog</a>
            </li>
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/teaching/">Teaching</a>
            </li>
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/pub/">Research</a>
            </li>
            
            <li class="pad-vertically">
                <a class="pad" href="https://vaclavblazej.github.io/about/">About</a>
            </li>
            
        </ul>
    </div>
</div>



<div class="content">
    
    <div class="post">
        <div class="post-title">
            <p class="footnote">
                


    <time datetime="2020-04-19T00:00:00Z" class="post-list timeago">19.04.2020</time>






    |



    tags:[ <a href="https://vaclavblazej.github.io/tags/system">system</a> <a href="https://vaclavblazej.github.io/tags/setup">setup</a> <a href="https://vaclavblazej.github.io/tags/programming">programming</a> ]






            </p>
            <h1>Command-line completion</h1>

            

        </div>
        <div class="post-content">
            <p>The setup of completion is an essential part of creating a well-behaved script.
Unfortunately, the setup has several obstacles, mainly that each shell handles completion differently.
In this post, I hope to unravel the problems and show solutions to setting up completion for a custom script in several frequently used unix shells.
The first section simply states the solution, its usage, and references used to accomplish these.
In the second section we show a detailed progression which lead to the solution.</p>
<h2 id="first-the-final-solution">First, the final solution</h2>
<p>When the completion is invoked we want to consider the command written up to that point, and complete the parameter under the cursor.</p>
<p>In the following example, we are trying to invoke completion while having the cursor at the location of <code>|</code> (pipe symbol).
The second line shows us what is the desired input for the completion.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ <span style="color:#6639ba">test</span> first <span style="color:#1f2328">|</span>  <span style="color:#57606a"># at the end</span>
</span></span><span style="display:flex;"><span>in: <span style="color:#0550ae">(</span><span style="color:#0a3069">&#39;test&#39;</span>, <span style="color:#0a3069">&#39;first&#39;</span>, <span style="color:#0a3069">&#39;&#39;</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ <span style="color:#6639ba">test</span> first  <span style="color:#0a3069">&#34;second second&#34;</span>    th<span style="color:#1f2328">|</span>ird  fourth  <span style="color:#57606a"># in the middle</span>
</span></span><span style="display:flex;"><span>in: <span style="color:#0550ae">(</span><span style="color:#0a3069">&#39;test&#39;</span>, <span style="color:#0a3069">&#39;first&#39;</span>, <span style="color:#0a3069">&#39;second second&#39;</span>, <span style="color:#0a3069">&#39;th&#39;</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ <span style="color:#6639ba">test</span> first <span style="color:#0a3069">\
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span>&gt; <span style="color:#0a3069">&#34;second second&#34;</span>    th<span style="color:#1f2328">|</span>ird  fourth  <span style="color:#57606a"># multiline</span>
</span></span><span style="display:flex;"><span>in: <span style="color:#0550ae">(</span><span style="color:#0a3069">&#39;test&#39;</span>, <span style="color:#0a3069">&#39;first&#39;</span>, <span style="color:#0a3069">&#39;second second&#39;</span>, <span style="color:#0a3069">&#39;th&#39;</span><span style="color:#0550ae">)</span>
</span></span></code></pre></div><p>The solution consists of two main parts.
First part handles the shell input and transforms it to the array shown above.
The array elements are then passed as arguments to a custom script.
We then have to handle script&rsquo;s output and pass it to completion system.</p>
<p>Second part is shell-independent and consists of the script which is given the written command and its arguments for completion and prints all the words which should be shown in completion.</p>
<p>The major advantage of this setup is that you may write the completion scipt in anything invokable (bash, python, c++, &hellip;) and don&rsquo;t have to care for what shell is running it.</p>
<h3 id="file-structure">file structure</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>completion_example/
</span></span><span style="display:flex;"><span>├── test_completion.py
</span></span><span style="display:flex;"><span>├── test_completion_setup.bash
</span></span><span style="display:flex;"><span>└── test_completion_setup.zsh
</span></span></code></pre></div><h3 id="test_completion_setupbash">test_completion_setup.bash</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#57606a">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#953800">DIR</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;</span><span style="color:#cf222e">$(</span><span style="color:#6639ba">cd</span> <span style="color:#0a3069">&#34;</span><span style="color:#cf222e">$(</span>dirname <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">BASH_SOURCE</span><span style="color:#1f2328">[0]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#cf222e">)</span><span style="color:#0a3069">&#34;</span> &gt;/dev/null 2&gt;<span style="color:#1f2328">&amp;</span><span style="color:#0550ae">1</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#6639ba">pwd</span><span style="color:#cf222e">)</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#953800">SCRIPT</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;</span><span style="color:#953800">$DIR</span><span style="color:#0a3069">/test_completion.py&#34;</span> <span style="color:#57606a"># relative to the script location</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">function</span> _my_custom_completion_func <span style="color:#0550ae">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">trimmed</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">COMP_LINE</span><span style="color:#1f2328">:</span><span style="color:#953800">0</span><span style="color:#1f2328">:</span><span style="color:#953800">$COMP_POINT</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">comp</span><span style="color:#0550ae">=(</span><span style="color:#953800">$trimmed</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">[</span> <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">trimmed</span><span style="color:#1f2328">: -1</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#39; &#39;</span> <span style="color:#0550ae">]</span><span style="color:#1f2328">;</span> <span style="color:#cf222e">then</span> <span style="color:#953800">comp</span><span style="color:#0550ae">+=(</span><span style="color:#0a3069">&#39;&#39;</span><span style="color:#0550ae">)</span><span style="color:#1f2328">;</span> <span style="color:#cf222e">fi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">COMPREPLY</span><span style="color:#0550ae">=()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">reply</span><span style="color:#0550ae">=(</span><span style="color:#cf222e">$(</span><span style="color:#0a3069">&#34;</span><span style="color:#953800">$SCRIPT</span><span style="color:#0a3069">&#34;</span> <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">comp</span><span style="color:#1f2328">[@]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#cf222e">)</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> reply_word in <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">reply</span><span style="color:#1f2328">[@]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">;</span> <span style="color:#cf222e">do</span> <span style="color:#953800">COMPREPLY</span><span style="color:#0550ae">+=(</span><span style="color:#0a3069">&#34;</span><span style="color:#953800">$reply_word</span><span style="color:#0a3069"> &#34;</span><span style="color:#0550ae">)</span><span style="color:#1f2328">;</span> <span style="color:#cf222e">done</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">complete</span> -o nospace -F _my_custom_completion_func <span style="color:#6639ba">test</span>
</span></span></code></pre></div><h3 id="test_completion_setupzsh">test_completion_setup.zsh</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-zsh" data-lang="zsh"><span style="display:flex;"><span><span style="color:#57606a">#!/usr/bin/env zsh
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#953800">DIR</span><span style="color:#0550ae">=</span><span style="color:#cf222e">$(</span>dirname <span style="color:#953800">$0</span>:A<span style="color:#cf222e">)</span>
</span></span><span style="display:flex;"><span><span style="color:#953800">SCRIPT</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;</span><span style="color:#953800">$DIR</span><span style="color:#0a3069">/test_completion.py&#34;</span> <span style="color:#57606a"># relative to the script location</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">function</span> _my_custom_completion_func <span style="color:#0550ae">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">local</span> cmd_string
</span></span><span style="display:flex;"><span>    <span style="color:#953800">cmd_string</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;</span><span style="color:#953800">$PREBUFFER$LBUFFER</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">cmd_string</span><span style="color:#0550ae">=</span><span style="color:#0a3069">${</span><span style="color:#953800">cmd_string</span><span style="color:#1f2328">/</span><span style="color:#0a3069">$&#39;\\\n&#39;</span><span style="color:#1f2328">/</span><span style="color:#0a3069">&#39; &#39;</span><span style="color:#0a3069">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">IFS</span><span style="color:#0550ae">=</span><span style="color:#0a3069">$&#39; &#39;</span> <span style="color:#953800">comp</span><span style="color:#0550ae">=(</span><span style="color:#cf222e">$(</span><span style="color:#6639ba">echo</span> <span style="color:#953800">$cmd_string</span><span style="color:#cf222e">)</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">[[</span> <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">cmd_string</span><span style="color:#1f2328">: -1</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#39; &#39;</span> <span style="color:#0550ae">]]</span><span style="color:#1f2328">;</span> <span style="color:#cf222e">then</span> <span style="color:#953800">comp</span><span style="color:#0550ae">+=(</span><span style="color:#0a3069">&#39;&#39;</span><span style="color:#0550ae">)</span><span style="color:#1f2328">;</span> <span style="color:#cf222e">fi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">ans_str</span><span style="color:#0550ae">=(</span><span style="color:#cf222e">$(</span><span style="color:#953800">$SCRIPT</span> <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">comp</span><span style="color:#1f2328">[@]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#cf222e">)</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">local</span> ans
</span></span><span style="display:flex;"><span>    <span style="color:#953800">IFS</span><span style="color:#0550ae">=</span><span style="color:#0a3069">$&#39; &#39;</span> <span style="color:#953800">ans</span><span style="color:#0550ae">=(</span><span style="color:#cf222e">$(</span><span style="color:#6639ba">echo</span> <span style="color:#953800">$ans_str</span><span style="color:#cf222e">)</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>    _describe <span style="color:#0a3069">&#39;test&#39;</span> ans
</span></span><span style="display:flex;"><span><span style="color:#0550ae">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>compdef _my_custom_completion_func <span style="color:#6639ba">test</span>
</span></span></code></pre></div><h2 id="references">References</h2>
<ul>
<li><a href="https://iridakos.com/programming/2018/03/01/bash-programmable-completion-tutorial"target="_blank">Iridakos &ndash; Creating a bash completion script<span style="white-space: nowrap;">&thinsp;↗</span></a></li>
<li><a href="https://www.gnu.org/software/bash/manual/html_node/Bash-Variables.html#Bash-Variables"target="_blank">Bash variables in completion<span style="white-space: nowrap;">&thinsp;↗</span></a></li>
<li><a href="https://stackoverflow.com/questions/40891097/how-to-make-bash-autocomplete-work-in-the-middle-of-line"target="_blank">SO: How to make bash autocomplete work in the middle of line?<span style="white-space: nowrap;">&thinsp;↗</span></a></li>
<li><a href="https://stackoverflow.com/questions/59895/how-to-get-the-source-directory-of-a-bash-script-from-within-the-script-itself?page=1&amp;tab=votes#tab-top"target="_blank">SO: How to get the source directory of a Bash script from within the script itself<span style="white-space: nowrap;">&thinsp;↗</span></a></li>
</ul>
<hr>
<h1 id="how-it-works">How it works</h1>
<p>Whenever you invoke the completion (tapping <code>&lt;tab&gt;</code> key once or twice) the unix shell (bash, zsh, etc.) invokes its own command which deals with completion (e.g. bash has <code>complete</code> command, zsh has <code>compdef</code>).
This command then finds function which is bound to the completed command and invokes it.
The invoked function returns a list of words which will be suggested, and potentially some other information.
If there is only one suggestion, then it is often substituted right away.</p>
<p>If you require only simple completion, the function for suggestions may be auto-generated.
On the other hand, if you want you may write the suggestion function yourself.</p>
<p>There are several unix shells, such as <strong>bash</strong>, <strong>zsh</strong>, so it would be nice to write the completion code only once, and make only its registration shell-dependent.
The flip-side is that some shells, for example <strong>zsh</strong>, provide additional functionality, which we might not be able to use with this approach.</p>
<h2 id="setup-script-for-bash">Setup script for BASH</h2>
<p>BASH provides a basic command-line completion capabilities via the <code>complete</code> command.</p>
<h3 id="register-completion">Register completion</h3>
<p>One of the following commands should be enough for the most basic cases.
By adding invocation of one of these on bash startup you will be able to invoke completion of that command.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#6639ba">complete</span> -W <span style="color:#0a3069">&#34;word1 word2&#34;</span> &lt;command_name&gt;  <span style="color:#57606a"># complete static set of words</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">complete</span> -A file &lt;command_name&gt;  <span style="color:#57606a"># complete files from the current directory</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">complete</span> -A directory &lt;command_name&gt;  <span style="color:#57606a"># complete directories from the current directory</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">complete</span> -F _my_custom_completion_func &lt;command_name&gt;  <span style="color:#57606a"># invoke the given function for completion</span>
</span></span></code></pre></div><p>Whenever the completion is non-trivial you will choose the last (function) variant.
Let&rsquo;s discuss how to write this function.</p>
<p>The following shows a command with cursor at the position of <code>|</code> (pipe symbol).
We tap <code>&lt;tab&gt;</code> key twice and our function will be invoked.
Our function will get all the necessary information via several variables, whose content is shown in the example below. (Note the weird spacing to distinguish raw input from the array.)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#6639ba">test</span> first    <span style="color:#0a3069">&#34;second second&#34;</span> th<span style="color:#1f2328">|</span>ird       fourth
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COMP_LINE:    <span style="color:#6639ba">test</span> first    <span style="color:#0a3069">&#34;second second&#34;</span> third       fourth  <span style="color:#57606a"># content of the input line</span>
</span></span><span style="display:flex;"><span>COMP_POINT:   <span style="color:#0550ae">32</span>  <span style="color:#57606a"># index into COMP_LINE where the cursor is located</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COMP_WORDS<span style="color:#0550ae">[]</span>: <span style="color:#6639ba">test</span> first <span style="color:#0a3069">&#34;second second&#34;</span> third fourth  <span style="color:#57606a"># array of command and its arguments</span>
</span></span><span style="display:flex;"><span>COMP_CWORD:   <span style="color:#0550ae">3</span>  <span style="color:#57606a"># index into COMP_WORDS where the cursor is located</span>
</span></span></code></pre></div><p>You may now extract the word for completion by <code>${COMP_WORDS[$COMP_CWORD]}</code> and from <code>COMP_CWORD</code> deduce what exactly you should complete.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#57606a">#!/usr/bin/env bash
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#57606a"># this file: completion_setup.sh</span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">function</span> _my_custom_completion_func <span style="color:#0550ae">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">COMPREPLY</span><span style="color:#0550ae">=(</span><span style="color:#cf222e">$(</span><span style="color:#6639ba">compgen</span> -W <span style="color:#0a3069">&#34;thursday third fourth&#34;</span> <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">COMP_WORDS</span><span style="color:#1f2328">[</span><span style="color:#953800">$COMP_CWORD</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#cf222e">)</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># compgen is a command provided to make custom completion creation easier</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">}</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">complete</span> -F _my_custom_completion_func <span style="color:#6639ba">test</span>
</span></span></code></pre></div><p>The result is set to the <code>COMPREPLY</code> variable with array of possible word completions.</p>
<p>Now run:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#6639ba">source</span> completion_setup.sh
</span></span><span style="display:flex;"><span>$ <span style="color:#6639ba">test</span> &lt;tab&gt;&lt;tab&gt;
</span></span><span style="display:flex;"><span>fourth     third     thursday  
</span></span><span style="display:flex;"><span>$ <span style="color:#6639ba">test</span> th&lt;tab&gt;&lt;tab&gt;
</span></span><span style="display:flex;"><span>third     thursday  
</span></span><span style="display:flex;"><span>$ <span style="color:#6639ba">test</span> thu&lt;tab&gt;
</span></span><span style="display:flex;"><span>$ <span style="color:#6639ba">test</span> thursday 
</span></span></code></pre></div><p>This is workable only if you can tolerate imperfections.
There is an ugly behavior waiting for you, if you try completion from the middle.
Let <code>|</code> be the cursor and see what doesn&rsquo;t work!</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#6639ba">test</span> <span style="color:#1f2328">|</span> thursday friday
</span></span><span style="display:flex;"><span>$ <span style="color:#6639ba">test</span> thursday<span style="color:#1f2328">|</span> thursday friday  <span style="color:#57606a"># :( I would expect list of all options</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ <span style="color:#6639ba">test</span> th<span style="color:#1f2328">|</span>ursday friday
</span></span><span style="display:flex;"><span>$ <span style="color:#6639ba">test</span> thursday<span style="color:#1f2328">|</span>rsday friday  <span style="color:#57606a"># :| again</span>
</span></span></code></pre></div><p>Note, that space after the completed parameter would be nice because by tapping <code>&lt;tab&gt;&lt;tab&gt;</code> now, we get nothing since the cursor is still at the end of the parameter</p>
<p>We will fix these issues now by adding 2 lines of code.</p>
<h3 id="fixing-the-completion-in-the-middle-of-arguments">Fixing the completion in the middle of arguments</h3>
<p>Note that <code>COMP_WORDS</code> and <code>COMP_CWORD</code> are unusable if you want the completion to work if the cursor is not at the end of an arugment.
The solution is to take <code>COMP_LINE</code> and truncate it to <code>COMP_POINT</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#cf222e">function</span> _my_custom_completion_func <span style="color:#0550ae">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">comp_words</span><span style="color:#0550ae">=(</span><span style="color:#0a3069">${</span><span style="color:#953800">COMP_LINE</span><span style="color:#1f2328">:</span><span style="color:#953800">0</span><span style="color:#1f2328">:</span><span style="color:#953800">$COMP_POINT</span><span style="color:#0a3069">}</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">COMPREPLY</span><span style="color:#0550ae">=(</span><span style="color:#cf222e">$(</span><span style="color:#6639ba">compgen</span> -W <span style="color:#0a3069">&#34;thursday third fourth&#34;</span> <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">comp_words</span><span style="color:#1f2328">[</span><span style="color:#953800">$COMP_CWORD</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#cf222e">)</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">}</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">complete</span> -F _my_custom_completion_func <span style="color:#6639ba">test</span>
</span></span></code></pre></div><p>You will notice that when trying the completion now it works, but does not append a space after completion which is not at the end of the line.
This is very weird behavior, which is intrinsic to the complete implementation.
We can fix it by appending each word with a space, and disabling the default space adding.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#cf222e">function</span> _my_custom_completion_func <span style="color:#0550ae">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">comp_words</span><span style="color:#0550ae">=(</span><span style="color:#0a3069">${</span><span style="color:#953800">COMP_LINE</span><span style="color:#1f2328">:</span><span style="color:#953800">0</span><span style="color:#1f2328">:</span><span style="color:#953800">$COMP_POINT</span><span style="color:#0a3069">}</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">COMPREPLY</span><span style="color:#0550ae">=()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">reply</span><span style="color:#0550ae">=(</span><span style="color:#cf222e">$(</span><span style="color:#6639ba">compgen</span> -W <span style="color:#0a3069">&#34;this thursday third fourth&#34;</span> <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">comp_words</span><span style="color:#1f2328">[</span><span style="color:#953800">$COMP_CWORD</span><span style="color:#1f2328">]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#cf222e">)</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#57606a"># add the space manually</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> reply_word in <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">reply</span><span style="color:#1f2328">[@]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">;</span> <span style="color:#cf222e">do</span> <span style="color:#953800">COMPREPLY</span><span style="color:#0550ae">+=(</span><span style="color:#0a3069">&#34;</span><span style="color:#953800">$reply_word</span><span style="color:#0a3069"> &#34;</span><span style="color:#0550ae">)</span><span style="color:#1f2328">;</span> <span style="color:#cf222e">done</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">}</span>
</span></span><span style="display:flex;"><span><span style="color:#57606a"># disable default spaces with -o nospace</span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">complete</span> -o nospace -F _my_custom_completion_func <span style="color:#6639ba">test</span>
</span></span></code></pre></div><p>The same attempts for completion as before give us the following results.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ <span style="color:#6639ba">test</span> <span style="color:#1f2328">|</span> thursday friday
</span></span><span style="display:flex;"><span>fouth      third      thursday
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ <span style="color:#6639ba">test</span> th<span style="color:#1f2328">|</span>ursday friday
</span></span><span style="display:flex;"><span>third      thursday
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ <span style="color:#6639ba">test</span> thu<span style="color:#1f2328">|</span>rsday friday
</span></span><span style="display:flex;"><span>$ <span style="color:#6639ba">test</span> thursday <span style="color:#1f2328">|</span>rsday friday
</span></span></code></pre></div><p>One last thing we notice about bash completion is that it doesn&rsquo;t work with multiline command, i.e., <code>ls \&lt;newline&gt; --&lt;tab&gt;&lt;tab&gt;</code> doesn&rsquo;t really run the <code>ls</code> completion script.
We can test this via printing some debugging message in our completion script, and notice it doesn&rsquo;t print when invoked from `test &lt;newline&gt; <tab><tab>
This seems to be problem of bash itself, so there is nothing we can do.</p>
<h3 id="binding-the-bash-completion-to-a-script">Binding the BASH completion to a script</h3>
<p>Our setup can be simply changed to invoke a script, which can be shell-independent.
The first option takes more work, but gives more power to the script.</p>
<p>The script should be placed <a href="https://stackoverflow.com/questions/59895/how-to-get-the-source-directory-of-a-bash-script-from-within-the-script-itself?page=1&amp;tab=votes#tab-top"target="_blank">next to this setup script<span style="white-space: nowrap;">&thinsp;↗</span></a>.</p>
<p>However, how do we distinguish case where there is a space after the last argument?
The trick is to check if the command ends in space, and append an empty argument if it is so.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#953800">DIR</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;</span><span style="color:#cf222e">$(</span><span style="color:#6639ba">cd</span> <span style="color:#0a3069">&#34;</span><span style="color:#cf222e">$(</span>dirname <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">BASH_SOURCE</span><span style="color:#1f2328">[0]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#cf222e">)</span><span style="color:#0a3069">&#34;</span> &gt;/dev/null 2&gt;<span style="color:#1f2328">&amp;</span><span style="color:#0550ae">1</span> <span style="color:#0550ae">&amp;&amp;</span> <span style="color:#6639ba">pwd</span><span style="color:#cf222e">)</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#953800">SCRIPT</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;</span><span style="color:#953800">$DIR</span><span style="color:#0a3069">/test_completion.py&#34;</span> <span style="color:#57606a"># relative to the script location</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">function</span> _my_custom_completion_func <span style="color:#0550ae">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">trimmed</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">COMP_LINE</span><span style="color:#1f2328">:</span><span style="color:#953800">0</span><span style="color:#1f2328">:</span><span style="color:#953800">$COMP_POINT</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">comp</span><span style="color:#0550ae">=(</span><span style="color:#953800">$trimmed</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">[</span> <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">trimmed</span><span style="color:#1f2328">: -1</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#39; &#39;</span> <span style="color:#0550ae">]</span><span style="color:#1f2328">;</span> <span style="color:#cf222e">then</span> <span style="color:#953800">comp</span><span style="color:#0550ae">+=(</span><span style="color:#0a3069">&#39;&#39;</span><span style="color:#0550ae">)</span><span style="color:#1f2328">;</span> <span style="color:#cf222e">fi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">COMPREPLY</span><span style="color:#0550ae">=()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">reply</span><span style="color:#0550ae">=(</span><span style="color:#cf222e">$(</span><span style="color:#0a3069">&#34;</span><span style="color:#953800">$SCRIPT</span><span style="color:#0a3069">&#34;</span> <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">comp</span><span style="color:#1f2328">[@]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#cf222e">)</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">for</span> reply_word in <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">reply</span><span style="color:#1f2328">[@]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#1f2328">;</span> <span style="color:#cf222e">do</span> <span style="color:#953800">COMPREPLY</span><span style="color:#0550ae">+=(</span><span style="color:#0a3069">&#34;</span><span style="color:#953800">$reply_word</span><span style="color:#0a3069"> &#34;</span><span style="color:#0550ae">)</span><span style="color:#1f2328">;</span> <span style="color:#cf222e">done</span>
</span></span><span style="display:flex;"><span><span style="color:#0550ae">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6639ba">complete</span> -o nospace -F _my_custom_completion_func <span style="color:#6639ba">test</span>
</span></span></code></pre></div><h2 id="setup-script-for-zsh">Setup script for ZSH</h2>
<p>ZSH provides advanced capabilities for command-line completion (<a href="http://zsh.sourceforge.net/Doc/Release/Completion-System.html"target="_blank">documentation<span style="white-space: nowrap;">&thinsp;↗</span></a>).
This means that not only it shows possible completions, but can also display additional information to each option in the form of description string.</p>
<p>There seem to be two different ways to setup completion in zsh.
Either we create a standardized file, used solely for defining the completion, and autoload it.
Or we create a setup script which we will invoke from <code>.zshrc</code> and register completion manually.</p>
<p>First, registering the function is quite easy.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-zsh" data-lang="zsh"><span style="display:flex;"><span>compdef _my_custom_completion_func <span style="color:#6639ba">test</span>
</span></span></code></pre></div><p>To extract what this complex machinery gives us to work with, we can run the <code>set &gt; vars.txt</code> command and compare results from default zsh terminal with that of completion script function.
This gives the following additional variables.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-zsh" data-lang="zsh"><span style="display:flex;"><span>$ <span style="color:#6639ba">test</span> first <span style="color:#0a3069">\
</span></span></span><span style="display:flex;"><span><span style="color:#0a3069"></span>&gt; <span style="color:#0a3069">&#34;second second&#34;</span> th<span style="color:#1f2328">|</span>ird       fourth   <span style="color:#57606a"># this is second line of the command</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#953800">BUFFER</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;&#34;second second&#34; third       fourth&#39;</span>  <span style="color:#57606a"># only the current line of the command</span>
</span></span><span style="display:flex;"><span><span style="color:#953800">CURSOR</span><span style="color:#0550ae">=</span><span style="color:#0550ae">18</span>  <span style="color:#57606a"># cursor position in the BUFFER</span>
</span></span><span style="display:flex;"><span><span style="color:#953800">PREBUFFER</span><span style="color:#0550ae">=</span><span style="color:#0a3069">$&#39;test first \\\n&#39;</span>  <span style="color:#57606a"># contains the command parts before the BUFFER</span>
</span></span><span style="display:flex;"><span><span style="color:#953800">LBUFFER</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;&#34;second second&#34; th&#39;</span>  <span style="color:#57606a"># part of the BUFFER before the cursor (only last line)</span>
</span></span><span style="display:flex;"><span><span style="color:#953800">RBUFFER</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#39;ird       fourth&#39;</span>  <span style="color:#57606a"># part of the BUFFER after the cursor (only last line)</span>
</span></span><span style="display:flex;"><span><span style="color:#953800">words</span><span style="color:#0550ae">=(</span> <span style="color:#6639ba">test</span> first <span style="color:#0a3069">&#39;&#34;second second&#34;&#39;</span> third fourth <span style="color:#0550ae">)</span>
</span></span></code></pre></div><p>We can now do a process similar to the one used for bash.
One cumbersome cookie is to tackle multiline commands.
We can acheve this by merging the PREBUFFER which contains already entered lines and the LBUFFER which contains left part of the current line.
We substitute newlines with spaces, to ignore them properly.
We push this through our script and parse the result into an array.
Finally, we can set list of completion words into the system via <code>_describe</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-zsh" data-lang="zsh"><span style="display:flex;"><span><span style="color:#57606a">#!/usr/bin/env zsh
</span></span></span><span style="display:flex;"><span><span style="color:#57606a"></span><span style="color:#953800">DIR</span><span style="color:#0550ae">=</span><span style="color:#cf222e">$(</span>dirname <span style="color:#953800">$0</span>:A<span style="color:#cf222e">)</span>
</span></span><span style="display:flex;"><span><span style="color:#953800">SCRIPT</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;</span><span style="color:#953800">$DIR</span><span style="color:#0a3069">/test_completion.py&#34;</span> <span style="color:#57606a"># relative to the script location</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#cf222e">function</span> _my_custom_completion_func <span style="color:#0550ae">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">local</span> cmd_string
</span></span><span style="display:flex;"><span>    <span style="color:#953800">cmd_string</span><span style="color:#0550ae">=</span><span style="color:#0a3069">&#34;</span><span style="color:#953800">$PREBUFFER$LBUFFER</span><span style="color:#0a3069">&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">cmd_string</span><span style="color:#0550ae">=</span><span style="color:#0a3069">${</span><span style="color:#953800">cmd_string</span><span style="color:#1f2328">/</span><span style="color:#0a3069">$&#39;\\\n&#39;</span><span style="color:#1f2328">/</span><span style="color:#0a3069">&#39; &#39;</span><span style="color:#0a3069">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">IFS</span><span style="color:#0550ae">=</span><span style="color:#0a3069">$&#39; &#39;</span> <span style="color:#953800">comp</span><span style="color:#0550ae">=(</span><span style="color:#cf222e">$(</span><span style="color:#6639ba">echo</span> <span style="color:#953800">$cmd_string</span><span style="color:#cf222e">)</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#cf222e">if</span> <span style="color:#0550ae">[[</span> <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">cmd_string</span><span style="color:#1f2328">: -1</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span> <span style="color:#0550ae">==</span> <span style="color:#0a3069">&#39; &#39;</span> <span style="color:#0550ae">]]</span><span style="color:#1f2328">;</span> <span style="color:#cf222e">then</span> <span style="color:#953800">comp</span><span style="color:#0550ae">+=(</span><span style="color:#0a3069">&#39;&#39;</span><span style="color:#0550ae">)</span><span style="color:#1f2328">;</span> <span style="color:#cf222e">fi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#953800">ans_str</span><span style="color:#0550ae">=(</span><span style="color:#cf222e">$(</span><span style="color:#953800">$SCRIPT</span> <span style="color:#0a3069">&#34;</span><span style="color:#0a3069">${</span><span style="color:#953800">comp</span><span style="color:#1f2328">[@]</span><span style="color:#0a3069">}</span><span style="color:#0a3069">&#34;</span><span style="color:#cf222e">)</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#6639ba">local</span> ans
</span></span><span style="display:flex;"><span>    <span style="color:#953800">IFS</span><span style="color:#0550ae">=</span><span style="color:#0a3069">$&#39; &#39;</span> <span style="color:#953800">ans</span><span style="color:#0550ae">=(</span><span style="color:#cf222e">$(</span><span style="color:#6639ba">echo</span> <span style="color:#953800">$ans_str</span><span style="color:#cf222e">)</span><span style="color:#0550ae">)</span>
</span></span><span style="display:flex;"><span>    _describe <span style="color:#0a3069">&#39;test&#39;</span> ans
</span></span><span style="display:flex;"><span><span style="color:#0550ae">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>compdef _my_custom_completion_func <span style="color:#6639ba">test</span>
</span></span></code></pre></div><p>If you want to delve into the sophisticated way of creating completion for zsh you may.
However, you will have to learn a entirely new tagging language used only for this purpose.
Hence, we delegated the work to a completion script.</p>
<h2 id="writing-a-completion-function">Writing a completion function</h2>
<p>We may create this script in any language of choice.
It will take the command and its arguments as arguments and output space-separated completion options into standard output.</p>
<pre tabindex="0"><code>invocation: ./script &lt;cmd&gt; &lt;cmd_arg1&gt; &lt;cmd_arg2&gt; ... &lt;last,partial arg&gt;
std output: &lt;completion_option1&gt; &lt;completion_option2&gt; ...
</code></pre><p>TODO: we will show more details on how to setup the script which is invoked by the completion setups</p>

        </div>
    </div>
</div>

<div class="footer">
    <ul class="pad-content">

        <li>
            © Václav Blažej
            
                2020
            
        </li>
        

        

        
    </ul>
    <ul title="Last update of the website" class="pull-right pad">28. January 2025</ul>
</div>

<script type="text/javascript">
    $("#toggle-btn").click(function(){
        $("#toggle-content").toggle();
        if($(this).html() === "☰") {
            $(this).html("X")
        } else {
            $(this).html("☰")
        }
    });
    $(window).resize(function(){
        if(window.innerWidth > 768) {
            $(".desktop").removeAttr("style");
        }
    });
</script>
</body>
</html>

